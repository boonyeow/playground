import React, { useEffect, useRef } from "react";
import { Button, Input } from "@chakra-ui/react";
import cfg from "../util/config";
import { fetchContractContent } from "../util/fetchContractContent";
import IconService from "icon-sdk-js";

const {
    IconConverter,
    IconBuilder,
    HttpProvider,
    SignedTransaction,
    IconWallet,
} = IconService;

const httpProvider = new HttpProvider(cfg.NODE_URL);
const iconService = new IconService(httpProvider);
const Test = () => {
    const inputCX = useRef(null);
    const inputScore = useRef(null);

    const wallet = "";
    useEffect(() => {
        wallet = IconWallet.loadPrivateKey(cfg.PRIVATE_KEY);
    }, []);

    const fileUploadEvent = async (e) => {
        console.log(e);
    };

    async function deployContract() {
        // const contractContent = await fetchContractContent(
        //     "https://siasky.net/CACHSYOEvx3Xe6U9JIcEtVU5qEy3ICIi_f1zMsFEdsOxtA"
        // );
        const contractContent =
            "0x504b03041400080808000000210000000000000000000000000014000d004d4554412d494e462f4d414e49464553542e4d46555405000100000000feca0000f34dcccb4c4b2d2ed10d4b2d2acecccfb35230d433e0e5f24dccccd375ce492c2eb65270e4e5e2e50200504b07082bc2bf352a00000028000000504b0304140008080800000021000000000000000000000000000d0009004d4554412d494e462f41504953555405000100000000bd54cb4ec240141da6e89e85dfc107604c604142426222b8814533d0a154db9966668af12f78768fbc242aa20bddf643fc18a70589226d95187793b977ce3939e7de79032917cc6bc844a48e4f1b0aecf6a72abd22983d16799d329cce6a1ac39c670ebcfe4835b497e2056aa1b48544339d33f4021158c72c93f03a8990920b161bfc1c12f5a64f325b91f065758be6c8eb8f250d7fadee464b799dc3b09a0b6e05bdc4e4fcaca0243a3172e1f3aa2495e9e9926006d125c0bd6088f0066679462d981cf4276a439e769a21e86f3d92deb690e9e0f08689aa21816eaa39c56bbbe0e9b39ac0bb7d24c5f829b3084445b56cc9e258646d9b51f92e4f59d634a18c74ae521b3324e8aed199ab287880b56125e9632c0d9e5ddfac20a2472f0abc931c565cb828afbd2ac9244d0c9441b4a2ff0db6edc2870f8141907fae2f4839486813e83a2fb8f81a1680bd3d9dfe16231cc95d0389eecfdcd9b171d09f85b1651001955e0cca4ce58e6d9bd7e11d63d56146284bcd61c41fd43816645187888828c19d5c80f2faa789478c54353d3688214e0068fb1209b2b002da219fd34c97b4988bb08e77504b0708496b5ccaa7010000cd050000504b03041400080808000000210000000000000000000000000007000900412e636c6173735554050001000000007d8dcd0ec1501085cf68a9ff225ec0aeb520626141244224123634f60d37cda56e132ecfc54a62e1013c94984a571666714e2667be33aff7e309a0872a814616886d62c120d467cb71b7b338875a7ad15ea8d6cebff884cc402aa98704c371d7456460e561224b30957f108c39ee3cbe6c87be0ada2b7d942ae813ec9fb62c8a042b10da1327cdf038da329c5f45e7e3464c6528d0408a8be33140f11f569bb72a3bb1a79b77e46edf03065148623b898d5ae99a84e57f61853585f407504b0708ac8be445bd00000008010000504b03041400080808000000210000000000000000000000000007000900422e636c6173735554050001000000009d57897f13d711fe9eb5f2caf2da38320e2c47224300592be118122036501f40e3d4c689c551db04ba96d6f682bc72562b08f4206d499bf4be5b4849537ad0236d81042327e0d2a64ddab44deffbbed2a6ed1fd05f7f69e9bcdd95906dc98680acdd9d7d73bc6fbe99797afe7f4f4d02588f7f31b076118ca166bf7a506d4caac67063cfe07e2d6e89f0d0cb0e115e86799dbd1d6b9bdad5b41e5fcdd7d10bfa9bd7958ea74cadb12d9130b574ba85a48364c895b69baa111fd9d24ee27ba7893676d9ce46556ba4b15d1fee342c6d58335bdc555bf4b8c5d74c355e5c6533fd27b77186d80c1fd3f4e7366e6fbe3d954a6aaa91b39c60a89ea24ac20dd36c15dfcc559331cbd48d61db5ef946ddd0adcd0c9e50c32e0901d4fa21603e836f50a5b5712dedc38d0cf38b9914b190a1ca71dd9122d9fd94a3450c95867628b76b86db43333d17483a922aedb7617a8e242cc1523f16e326097e5456a00c410a4a1d1b335307d5a40fcb186e980192885b245439cb57325458a9039ab12f63ea3e84a630ca894344981651b40e700c6baf2756177e09114479a4ab25cc430d777d2b5975e1eb1962d814ba26ea34141753bea76223e2368632d562585918ae5324392b852209ebb0be12b76303835418bb886606a17f6b6f0fc38dc5bd4bd8884d15904114918635abc7dca20da9992479df50c4fb35c6d38ab64ab48010afcee3d4ae5af11186d6d0c034b4064ac05542ceb0665fea90a199e9a06a9aeae1605a3fa2054733692b38ca5d040fe9d648709f9e287cefc33606d1d4eecbe8a6466084fa671281d7c79de8e4a9be8b614109f722ba24acc15a3ff1603b31d6a6e0cede4e867068d6bc17baa27224ac25f4f2bcb52046d85b94fdf490666e3353a30c3d3328752d0c2b2e1d686fd8458425871d6a32a9995458a18669f624ecc66bf9cefb24f850c1493e90af7d7791887ba99f10846a32cd50578c9bfd12f6e1757eec0575ebf9fbac949397412d68a48ce811cd4cf940adb3464fb7d985ae25b6a5ccb66492a17e8e0d73d31a8638eac30cabb76b5a22981ad34cd54a99c15cd7080ed1c35a33111c534deb70300729b5389d0088a74649aeed4831c8a552d529e100927eaa074a42a0d348678686f4b8ae195670286324c81269fbd29941b21da71a593d7bce6756db7d30b97502d093d6c8c0aa6b2b32a266060739570e91a69a484838ec583a4235b6c3dd688cb895247aef998b3daf9c4c3c9237e08d3c0f6f62f0eb693e181c2c68c250921ec09b79fedf42d33a65d853bc578b6b3aa5da8763d4d706a82bbd8da17660e62e453c44ed2aae723edc59bca7161651110b459bd13bf04eceec7711ef0b8bcced47f7cc81558936504a6cd7da023dd14874cc6844449dfad4a89eb65b930fef63581c2ad9f0da79f17d8063fb412abe5c56dd406fbbbea40eb4f358247c181fe1063f4af5e8e6c3b6773529c70917a2629b5b43b982ac9deeae9fef4cb4b7c5871eb5d042b473a7180927f1a81f2bf009e2e5749bcbe6d8423f0ff89338c503fe14f5c441c7e82eee53c26738b356e0b30c8d53091f72f523d3afba61f1bf061f3e47559b4c0d6f3d4895ccd0102ac29d6274a270be802f72f63c4e63674a424a3a1d3c6c69ee3739fe32c32d536198a1c877492bcff0b67457c9c67112e778b93f4175664f1ba544e72936d7084ad2097138d29649be2e509d85fa9d8137c1b7f714097abbee367cb8c8b0909fef28fe363e3e1d28769bbac5274753910354fe6c574c85229fc457b98bcb44fd59168af83a3f5569c3bad1a5a72d1e60270ff01bf866259ec1b30cde437ce12ccd9b567f0bdfe6ab9f279434839ae47751cb9fbf4787562b95f7cb8ddbd5f67dfc80bffe21cdb5a4660c5b237617a321f063fcc40f053fa5dad869eac1f4482a934cf0394695e2c3cf259cc73867e92f19365fdbe9af54cc54269d0691434f04d5d154c620f3bfe167dc5f73f3bfa31f04b4633624e10f8ee44f44e48df1a47ba8f7869c220fe0afbce9be4808c6f46143b532fc942374a41274a98a596afc40b73ab6431de4d3c11f4b65ccb8b64d4f6a423d991440dba76f994f7efa9116e0077292fd9deecbc08d57153c57d3331d83f3cf37a096ee03f6f74b2459030fdd012bc31750170e2c08c859dc7c1ef5e1c0f2c00afb765538d01050b2683c8fa6b3e0ff183f50b9fa2b49df43d745e127511f99c01d65b88c16e51c5e35810e0fddcb675c9d2dd8eaeaf453fc5ebadea14c46261f83289c86e009bc3a8bd7289397206ff7ac13ea0465f214e4689d1056ea843511fa1b474fec98c04e5f79317ac636f80ffa9e07a1b295fd175522bad97fe8470ac3ddb8c7f5b388f65b46d76a8aad4999c00e1e9b928b67277639eb5837c5e323d90b59f4379747ce61cf38064fe4e24af0b8e4725b5415b6ef468ee75eeea797b45759188771127532851ba540ed2777c9182de1e04473e0348bb2a838ebb89e3581fb3d90c548389213bdde1685e5722512e5cf4723e378eb71dc1a093ce8bb04a1cf2397c7fa0425d6e78dc6faca6521d627cadee750e1b9e83b0dafec8d65f1eedd67f3208dc2ff326a45ec6d650b3cadacbe955da1838d4f4419c9ec8f6c7fde6edfb7c06b5f15110fd387d6b259d6964f592b42e0f47c0fdeeb427b99a0ada2ebfc92d0462765e12a09de3f17d89e75629d18256e1c8dd6896b9a7db2c02f1572056581507f640aea8aec23449bfd7285ec9f919288f3b292e746f6e59323c9922293463e315244aee48f4e528e89c4c0079cd464f12159a0af717c2c9fa013af24412750934b508d93a3972112ab973968f3c7c5f6f50ada2016e4a2dbfef05c0057b0a9d4bb99092db1b068361fc1c7dd826aa4b623d0753965733be1b62acf696549168f39ac8d2a4bc6f1e95ca7a01f01ae72d8ed1437714525a718f1d88a76ab58318ed38fbb7a746875f536914b5e9d4d35820d6de0f32eb41182361a6b2eaf2973202794058296caab5c16b3f8522e043a529532f595eb3445871dd7d47aea60e574556a3c8ea9b37953cd420db3654b1fcce2c958b357265b05466816b946a2140f6f84f5aedf40d636b2ddd5e7a6a29c61aeaa7ddc745533d4d9b8ffcef0b32eabb3783a70298baf7529e1c9093c578670776472b3dd4b979ec202de429bbd8aec9dc077ca6037d297280b2fd0d164023f62b8da531741f071aa2de4bc21663cc37b2bcd887fd3c81168d8e4a26f7613ba9cc8ffb34773b5f50ba7dd352911870e0abdfdd555aa7b51460d9b82a791e9dae976515817756a386feab7760d4778950a53c78b2c44730539c5743599166828e44cdf6c4f4aa096cc90c6efc33498f6d8b7471d48cbf8a076178fb87174ce1687ed795a9b99199a352db42a08d5bc8a9d6a263f7f2c15e29fc30a8fb120441ffe929fd68b6dc069ec3d8dbd7d3575177d17f0b727b027c7ac7fda3b12ff0f504b07087ab394e5a5090000be150000504b03041400080808000000210000000000000000000000000007000900432e636c6173735554050001000000003bf56fd73e06060673067646064667760646460681acc4b244fd9cc4bc747dffa4acd4e41276066646062ecf206763433d901c90139c5f5a949cea969993cac6c8c0c4c0c200018c0c6c409289811500504b07081509ecd55000000057000000504b03041400080808000000210000000000000000000000000007000900442e636c6173735554050001000000009554db52d350145d8706524ac052b955518b17e805a8888852c4d2025ab9292d38c35bda1e4b20243549517ec6579f71948b0f3eea8c1fe5b84f29523030e34b76b273f6da6bafb3cef9f5fbdb7700e378c3c06664300a29191e864066253d3ab2a8194eaa6219c39bea8e4aff3843db825d302d1e9fd10ace4c2ac130762631b92096c6b75567239ed24a19c3e1256e256a6ba68b458bdb76628aea9a26354373a6183ce1c89a8266f87c90d0c2e02d585c754ccbf6a295a1f54ca58c2b7f536993c03f3832da199a0dfefe9800c368f89883ae1aa578d6b134a394a8cba475951844ce8ea1e02a3a7c08a0534113e46634a09b41daa6f919a6c3170c7549b6be79648d41a96f27e33a8d5de284dd5f4f7639bfc90b0e71fb27a5e0066eb6a017b718ba73e61637429a1d527552aab81b123479d18b3e06d9e2ef2a9a451bd5155e77a3a2e00eee8a49ef3174b80d206380265f9f5d59260cf7111544106d46183152be606e97558be74c86e0054245320a8630eca38a38adca56ca657d37646f9815bd18caf350d9b43547dbe15e8c1020e99256759d5b0cede1c839e72818c543417f8c14b48582032e0aba684a838fe3b190f00919b9c830153e07fd3f9b2ce01298148e7d4a707986d8a52639bf07cf9014b5d3a4749ece1743fcbf3c261ce5cf183baaae1543ceb11d68ff6749dce96db36238aee23e27a66f15648e79bf64682101ab665a5dc9d08124e7a8bacdd0e9e6c975058b58f2c10ff245fb92e9d4fad60eab17af69ebb25ac9509d8ab09f94368b145ab38e5ad85a54cb3935afd3b72f6b56ac029fd3742ef5d12993e8faa1db461c3a8a59fa6a8097b24c5c08f4cc51a6171e7a03fcd10328d1405bc07f88aeafe8d903aad5415cabade454d948713efa053db123841af013b2f409922770fb10fd839f31b88ffb1f4f720f287788471352757d503ac28407d1a0141b3cc05434367480d45eb5c52a3d89567b920592a422d298a9b55ca6961e8a63a72d7f9cc0cfb9b47c41b928f5142de6ddc11790ac8187095a80f752c129fe3e5e0556048cc0489da8b056d5aef10f504b0708e644e662ff020000d3050000504b01021400140008080800000021002bc2bf352a0000002800000014000d0000000000000000000000000000004d4554412d494e462f4d414e49464553542e4d46555405000100000000feca0000504b0102140014000808080000002100496b5ccaa7010000cd0500000d00090000000000000000000000790000004d4554412d494e462f41504953555405000100000000504b0102140014000808080000002100ac8be445bd00000008010000070009000000000000000000000064020000412e636c617373555405000100000000504b01021400140008080800000021007ab394e5a5090000be15000007000900000000000000000000005f030000422e636c617373555405000100000000504b01021400140008080800000021001509ecd550000000570000000700090000000000000000000000420d0000432e636c617373555405000100000000504b0102140014000808080000002100e644e662ff020000d30500000700090000000000000000000000d00d0000442e636c617373555405000100000000504b050600000000060006008b0100000d1100000000";

        // Estimate required step - create transaction without step limit
        // https://icondev.io/getting-started/how-to-write-a-smart-contract/how-to-estimate-required-step
        const httpProvider_debug = new HttpProvider(cfg.DEBUG_URL);
        const iconService_debug = new IconService(httpProvider_debug);
        const txObj = new IconService.IconBuilder.DeployTransactionBuilder()
            .nid(cfg.NID)
            .from(wallet.address)
            .to("cx489abf1ffc9d80e6fcc45e600d49255d3195dd41") //use the same address to update contract else, use cfg.SCORE_INSTALL_ADDRESS
            //.to(cfg.SCORE_INSTALL_ADDRESS)
            .version(IconConverter.toBigNumber(3))
            .timestamp(Date.now() * 1000)
            .contentType("application/java")
            .content(contractContent)
            .params({})
            .nonce(IconConverter.toBigNumber(1))
            .build();

        const estimatedSteps = IconConverter.toBigNumber(
            await iconService_debug.estimateStep(txObj).execute()
        );

        const margin = IconConverter.toBigNumber(10000);

        // Add step limit property to transaction
        txObj.stepLimit = IconService.IconConverter.toHex(
            estimatedSteps.plus(margin)
        );

        // Make signed transaction
        const signedTransaction = new SignedTransaction(txObj, wallet);
        const txHash = await iconService
            .sendTransaction(signedTransaction)
            .execute();
        console.log("txhash", txHash);
        setTimeout(async () => {
            const txObject = await iconService
                .getTransactionResult(txHash)
                .execute();
            console.log(txObject);
        }, 5000);

        return;
    }

    return (
        <>
            <Input ref={inputCX} placeholder="cx addy"></Input>
            <Input
                type="file"
                ref={inputScore}
                onChange={fileUploadEvent}
            ></Input>
            <Button onClick={deployContract}>Deploy</Button>
        </>
    );
};

export default Test;
